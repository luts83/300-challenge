#!/bin/bash

echo "π” 300 Challenge ν™κ²½ λ³€μ μ•”νΈν™” λ„κµ¬"
echo "======================================"

# ν„μ¬ λ””λ ‰ν† λ¦¬ ν™•μΈ
if [ ! -f "env.template" ]; then
    echo "β env.template νμΌμ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤."
    echo "   ν”„λ΅μ νΈ λ£¨νΈ λ””λ ‰ν† λ¦¬μ—μ„ μ‹¤ν–‰ν•΄μ£Όμ„Έμ”."
    exit 1
fi

# λ©”λ‰΄ μ„ νƒ
echo ""
echo "μ–΄λ–¤ μ‘μ—…μ„ μν–‰ν•μ‹κ² μµλ‹κΉ?"
echo "1. ν™κ²½ λ³€μ μ•”νΈν™” (GitHub μ—…λ΅λ“μ©)"
echo "2. μ•”νΈν™”λ νμΌ λ³µνΈν™”"
echo "3. μ•”νΈν™” ν‚¤ μƒμ„±"
echo "4. μΆ…λ£"
echo ""

read -p "μ„ νƒν•μ„Έμ” (1-4): " choice

case $choice in
    1)
        echo "π”’ ν™κ²½ λ³€μλ¥Ό μ•”νΈν™”ν•©λ‹λ‹¤..."
        
        # μ•”νΈν™” ν‚¤ ν™•μΈ
        if [ ! -f ".env.key" ]; then
            echo "β οΈ  μ•”νΈν™” ν‚¤κ°€ μ—†μµλ‹λ‹¤. λ¨Όμ € ν‚¤λ¥Ό μƒμ„±ν•΄μ£Όμ„Έμ”."
            echo "   3λ²μ„ μ„ νƒν•μ—¬ μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•μ„Έμ”."
            exit 1
        fi
        
        # .env νμΌμ΄ μλ”μ§€ ν™•μΈ
        if [ ! -f ".env" ]; then
            echo "β οΈ  .env νμΌμ΄ μ—†μµλ‹λ‹¤. λ¨Όμ € ν™κ²½ λ³€μλ¥Ό λ°±μ—…ν•΄μ£Όμ„Έμ”."
            echo "   ./sync-env.shλ¥Ό μ‹¤ν–‰ν•μ—¬ 1λ²μ„ μ„ νƒν•μ„Έμ”."
            exit 1
        fi
        
        # ν™κ²½ λ³€μ μ•”νΈν™”
        openssl enc -aes-256-cbc -salt -in .env -out .env.encrypted -pass file:.env.key
        
        if [ $? -eq 0 ]; then
            echo "β… ν™κ²½ λ³€μκ°€ μ•”νΈν™”λμ—μµλ‹λ‹¤!"
            echo "π“ μ•”νΈν™”λ νμΌ: .env.encrypted"
            echo "π’΅ μ΄ νμΌμ„ GitHubμ— μ—…λ΅λ“ν•  μ μμµλ‹λ‹¤."
            echo "π”‘ λ³µνΈν™”ν•λ ¤λ©΄ .env.key νμΌμ΄ ν•„μ”ν•©λ‹λ‹¤."
        else
            echo "β μ•”νΈν™”μ— μ‹¤ν¨ν–μµλ‹λ‹¤."
            exit 1
        fi
        ;;
        
    2)
        echo "π”“ μ•”νΈν™”λ νμΌμ„ λ³µνΈν™”ν•©λ‹λ‹¤..."
        
        # μ•”νΈν™” ν‚¤ ν™•μΈ
        if [ ! -f ".env.key" ]; then
            echo "β μ•”νΈν™” ν‚¤(.env.key)λ¥Ό μ°Ύμ„ μ μ—†μµλ‹λ‹¤."
            echo "   λ©”μΈ μ»΄ν“¨ν„°μ—μ„ .env.key νμΌμ„ λ³µμ‚¬ν•΄μ£Όμ„Έμ”."
            exit 1
        fi
        
        # μ•”νΈν™”λ νμΌ ν™•μΈ
        if [ ! -f ".env.encrypted" ]; then
            echo "β μ•”νΈν™”λ νμΌ(.env.encrypted)μ„ μ°Ύμ„ μ μ—†μµλ‹λ‹¤."
            echo "   GitHubμ—μ„ .env.encrypted νμΌμ„ λ‹¤μ΄λ΅λ“ν•΄μ£Όμ„Έμ”."
            exit 1
        fi
        
        # ν™κ²½ λ³€μ λ³µνΈν™”
        openssl enc -aes-256-cbc -d -in .env.encrypted -out .env -pass file:.env.key
        
        if [ $? -eq 0 ]; then
            echo "β… ν™κ²½ λ³€μκ°€ λ³µνΈν™”λμ—μµλ‹λ‹¤!"
            echo "π“ λ³µνΈν™”λ νμΌ: .env"
            echo "π’΅ μ΄μ  ./sync-env.shλ¥Ό μ‹¤ν–‰ν•μ—¬ ν™κ²½ λ³€μλ¥Ό λ³µμ›ν•  μ μμµλ‹λ‹¤."
        else
            echo "β λ³µνΈν™”μ— μ‹¤ν¨ν–μµλ‹λ‹¤."
            echo "   μ•”νΈν™” ν‚¤κ°€ μ¬λ°”λ¥Έμ§€ ν™•μΈν•΄μ£Όμ„Έμ”."
            exit 1
        fi
        ;;
        
    3)
        echo "π”‘ μ•”νΈν™” ν‚¤λ¥Ό μƒμ„±ν•©λ‹λ‹¤..."
        
        if [ -f ".env.key" ]; then
            echo "β οΈ  μ•”νΈν™” ν‚¤κ°€ μ΄λ―Έ μ΅΄μ¬ν•©λ‹λ‹¤."
            read -p "μƒλ΅ μƒμ„±ν•μ‹κ² μµλ‹κΉ? (y/N): " overwrite
            if [[ ! $overwrite =~ ^[Yy]$ ]]; then
                echo "β μ·¨μ†λμ—μµλ‹λ‹¤."
                exit 0
            fi
        fi
        
        # 32λ°”μ΄νΈ λλ¤ ν‚¤ μƒμ„±
        openssl rand -out .env.key 32
        
        if [ $? -eq 0 ]; then
            echo "β… μ•”νΈν™” ν‚¤κ°€ μƒμ„±λμ—μµλ‹λ‹¤!"
            echo "π“ ν‚¤ νμΌ: .env.key"
            echo "β οΈ  μ΄ νμΌμ„ μ•μ „ν•κ² λ³΄κ΄€ν•μ„Έμ”!"
            echo "π’΅ λ‹¤λ¥Έ μ»΄ν“¨ν„°μ—μ„ ν™κ²½ λ³€μλ¥Ό λ³µνΈν™”ν•λ ¤λ©΄ μ΄ ν‚¤κ°€ ν•„μ”ν•©λ‹λ‹¤."
            echo ""
            echo "π” ν‚¤ μ •λ³΄:"
            echo "   ν¬κΈ°: $(wc -c < .env.key) bytes"
            echo "   ν•΄μ‹: $(openssl dgst -sha256 .env.key | cut -d' ' -f2)"
        else
            echo "β ν‚¤ μƒμ„±μ— μ‹¤ν¨ν–μµλ‹λ‹¤."
            exit 1
        fi
        ;;
        
    4)
        echo "π‘‹ μΆ…λ£ν•©λ‹λ‹¤."
        exit 0
        ;;
        
    *)
        echo "β μλ»λ μ„ νƒμ…λ‹λ‹¤. 1-4 μ¤‘μ—μ„ μ„ νƒν•΄μ£Όμ„Έμ”."
        exit 1
        ;;
esac

echo ""
echo "π’΅ λ³΄μ• ν:"
echo "   - .env.key νμΌμ€ μ λ€ GitHubμ— μ—…λ΅λ“ν•μ§€ λ§μ„Έμ”!"
echo "   - .env.key νμΌμ€ USBλ‚ μ•μ „ν• λ°©λ²•μΌλ΅ μ „μ†΅ν•μ„Έμ”."
echo "   - .env.encrypted νμΌλ§ GitHubμ— μ—…λ΅λ“ν•μ„Έμ”."
echo "   - μ•”νΈν™” ν‚¤λ” λ¶„μ‹¤ν•μ§€ λ§μ„Έμ”!"
